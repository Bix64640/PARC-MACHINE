<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recensement des Syst√®mes</title>
    <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #2f3781 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    .header {
      background: #2c3e50;
      color: white;
      padding: 20px;
      text-align: center;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      padding: 20px;
      background: #f8f9fa;
      border-bottom: 1px solid #ddd;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      flex: 1 1 200px;
    }
    .control-group label {
      font-size: 0.9em;
      margin-bottom: 5px;
    }
    input, select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .btn {
      background: #3c71d3;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-top: auto;
    }
    .btn:hover { background: #5563d6; }
    .delete-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .delete-btn:hover { background: #c0392b; }
    .details-btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .details-btn:hover { background: #2980b9; }
    .table-container { padding: 20px; }
    table { width: 100%; border-collapse: collapse; background: white; }
    th, td { padding: 12px; border-bottom: 1px solid #eee; text-align: left; }
    th { background: #34495e; color: white; }
    .details-section {
      display: none;
      padding: 20px;
      border-top: 2px solid #ddd;
      background: #f9f9f9;
    }
    .details-section h2 { margin: 0; }
    .details-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .details-table th, .details-table td { padding: 10px; border: 1px solid #ddd; }
  </style>
</head>
<body>
  <h1>üìä Recensement des Syst√®mes</h1>

  <div class="controls">
    <div>
      <label>Site</label><br>
      <select id="site">
        <option value="">S√©lectionner un site</option>
        <option value="VOLTAIRE_BIDART">VOLTAIRE_BIDART</option>
        <option value="VOLTAIRE_MOLENE">VOLTAIRE_MOLENE</option>
        <option value="MEYER_COGNAC">MEYER_COGNAC</option>
      </select>
    </div>
    <div>
      <label>Nom du Syst√®me</label><br>
      <input type="text" id="nomSysteme">
    </div>
    <div>
      <label>Heures/Jour</label><br>
      <input type="number" id="heuresJour" min="0" max="24">
    </div>
    <div>
      <label>Jours/Semaine</label><br>
      <input type="number" id="joursSemaine" min="1" max="7">
    </div>
    <div>
      <label>Criticit√©</label><br>
      <select id="criticiteSysteme">
        <option value="">S√©lectionner</option>
        <option value="Faible">Faible</option>
        <option value="Moyenne">Moyenne</option>
        <option value="√âlev√©e">√âlev√©e</option>
        <option value="Critique">Critique</option>
      </select>
    </div>
    <div>
      <label>En service</label><br>
      <select id="service">
        <option value="">S√©lectionner</option>
        <option value="Oui">Oui</option>
        <option value="Non">Non</option>
      </select>
    </div>
    <div>
      <label>Maintenabilit√©</label><br>
      <select id="maintenabilite">
        <option value="">S√©lectionner</option>
        <option value="Facile">Facile</option>
        <option value="Moyenne">Moyenne</option>
        <option value="Difficile">Difficile</option>
      </select>
    </div>
    <div style="align-self:flex-end;">
      <button id="btnAjouter" class="btn btn-primary">‚ûï Ajouter Syst√®me</button>
    </div>
  </div>

  <table id="tableauSystemes">
    <thead>
      <tr>
        <th>Site</th>
        <th>Nom Syst√®me</th>
        <th>H/J</th>
        <th>J/S</th>
        <th>Total H/S</th>
        <th>Criticit√©</th>
        <th>En service </th>
        <th>Maintenabilit√©</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="corpsTableau"></tbody>
  </table>

  <!-- Section d√©tails -->
  <div class="details-section" id="detailsSection">
    <div class="details-header">
      <h2>D√©tails du syst√®me : <span id="detailsSystemeNom"></span></h2>
      <div>
        <button onclick="modifierDetails()" class="btn btn-info">‚úèÔ∏è Modifier</button>
        <button onclick="masquerDetails()" class="btn btn-danger">‚ùå Fermer</button>
      </div>
    </div>
    <table class="details-table">
      <tr><th>Nb employ√©s affect√©s</th><td id="nbEmployesValue"></td></tr>
      <tr><th>Taux horaire</th><td id="tauxHoraireValue"></td></tr>
      <tr><th>Machines similaires</th><td id="nbMachinesSimilairesValue"></td></tr>
      <tr><th>Temps total de panne (h)</th><td id="tempsPanneValue"></td></tr>
      <tr><th>Nombre de pannes</th><td id="nbPannesValue"></td></tr>
      <tr><th>Co√ªt d'indisponibilit√© /h</th><td id="coutHeureValue"></td></tr>
      <tr><th>MTBF (h)</th><td id="mtbfValue"></td></tr>
    </table>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://wmdghiouwtezkndrhsgm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtZGdoaW91d3RlemtuZHJoc2dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTAxNTgsImV4cCI6MjA3MTE4NjE1OH0.kjGVpTkzQsofxYte1JrYlq3A0BnJ3igI2WQPMttaB84";
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let systemes = [];
    let systemeActuel = null;

    // Charger les syst√®mes
    async function chargerDonnees() {
      const { data, error } = await supabaseClient.from("systemes").select("*").order("id", { ascending:false });
      if (error) { console.error(error); return; }
      systemes = data;
      afficherTableau();
    }

    // Ajouter un syst√®me
    async function ajouterSysteme() {
      const site = document.getElementById("site").value;
      const nomSysteme = document.getElementById("nomSysteme").value;
      const heuresJour = parseFloat(document.getElementById("heuresJour").value) || 0;
      const joursSemaine = parseInt(document.getElementById("joursSemaine").value) || 0;
      const criticite = document.getElementById("criticiteSysteme").value;
      const service = document.getElementById("service").value;
      const maintenabilite = document.getElementById("maintenabilite").value;

      if (!site || !nomSysteme) { alert("Champs obligatoires manquants"); return; }

      const nouveauSysteme = {
        site, nom_systeme: nomSysteme, heures_jour: heuresJour, jours_semaine: joursSemaine,
        total_heures: heuresJour * joursSemaine,
        criticite, service, maintenabilite,
        nb_employes:0, taux_horaire:0, nb_machines_similaires:1, temps_panne:0, nb_pannes:0
      };

      const { error } = await supabaseClient.from("systemes").insert([nouveauSysteme]);
      if (error) console.error(error);
      else chargerDonnees();
    }

    function afficherTableau() {
      const corps = document.getElementById("corpsTableau");
      corps.innerHTML = "";
      systemes.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.site}</td>
          <td>${s.nom_systeme}</td>
          <td>${s.heures_jour}</td>
          <td>${s.jours_semaine}</td>
          <td>${s.total_heures}</td>
          <td>${s.criticite}</td>
          <td>${s.service}</td>
          <td>${s.maintenabilite}</td>
          <td>
            <button class="btn btn-info" onclick="afficherDetails(${s.id})">D√©tails</button>
            <button class="btn btn-danger" onclick="supprimerSysteme(${s.id})">Supprimer</button>
          </td>
        `;
        corps.appendChild(tr);
      });
    }

    async function afficherDetails(id) {
      const systeme = systemes.find(s => s.id === id);
      if (!systeme) return;
      systemeActuel = systeme;

      const coutIndispo = (systeme.nb_employes * systeme.taux_horaire) / (systeme.nb_machines_similaires || 1);
      const totalFonctionnement = systeme.total_heures * 52;
      const mtbf = systeme.nb_pannes > 0 ? (totalFonctionnement / systeme.nb_pannes).toFixed(2) : "N/A";

      document.getElementById("detailsSystemeNom").textContent = systeme.nom_systeme;
      document.getElementById("nbEmployesValue").textContent = systeme.nb_employes;
      document.getElementById("tauxHoraireValue").textContent = systeme.taux_horaire + " ‚Ç¨";
      document.getElementById("nbMachinesSimilairesValue").textContent = systeme.nb_machines_similaires;
      document.getElementById("tempsPanneValue").textContent = systeme.temps_panne + " h";
      document.getElementById("nbPannesValue").textContent = systeme.nb_pannes;
      document.getElementById("coutHeureValue").textContent = isNaN(coutIndispo) ? "N/A" : coutIndispo.toFixed(2) + " ‚Ç¨/h";
      document.getElementById("mtbfValue").textContent = mtbf;

      document.getElementById("detailsSection").style.display = "block";
    }

    async function modifierDetails() {
      if (!systemeActuel) return;

      const nbEmployes = parseInt(prompt("Nb employ√©s:", systemeActuel.nb_employes)) || 0;
      const tauxHoraire = parseFloat(prompt("Taux horaire (‚Ç¨):", systemeActuel.taux_horaire)) || 0;
      const nbMachines = parseInt(prompt("Nb machines similaires:", systemeActuel.nb_machines_similaires)) || 1;
      const tempsPanne = parseFloat(prompt("Temps panne (h):", systemeActuel.temps_panne)) || 0;
      const nbPannes = parseInt(prompt("Nb pannes:", systemeActuel.nb_pannes)) || 0;

      const maj = { nb_employes: nbEmployes, taux_horaire:tauxHoraire, nb_machines_similaires:nbMachines, temps_panne:tempsPanne, nb_pannes:nbPannes };

      const { error } = await supabaseClient.from("systemes").update(maj).eq("id", systemeActuel.id);
      if (error) { console.error(error); return; }

      Object.assign(systemeActuel, maj);
      afficherDetails(systemeActuel.id);
      chargerDonnees();
    }

    async function supprimerSysteme(id) {
      if (!confirm("Supprimer ce syst√®me ?")) return;
      await supabaseClient.from("systemes").delete().eq("id", id);
      masquerDetails();
      chargerDonnees();
    }

    function masquerDetails() {
      document.getElementById("detailsSection").style.display = "none";
    }

    // Init
    document.getElementById("btnAjouter").addEventListener("click", ajouterSysteme);
    chargerDonnees();
  </script>
</body>
</html>

