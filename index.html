<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recensement des Syst√®mes</title>
    <style>
    
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 30px;
        text-align: center;
    }

    .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        font-weight: 700;
    }

    .header p {
        font-size: 1.1em;
        opacity: 0.9;
    }

    .controls {
        background: #f8f9fa;
        padding: 25px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        gap: 20px;
        flex-wrap: wrap;
        align-items: center;
    }

    .control-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .control-group label {
        font-weight: 600;
        color: #495057;
        font-size: 0.9em;
    }

    input, select {
        padding: 12px 16px;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        background: white;
    }

    input:focus, select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.3s ease;
        margin-top: 20px;
    }
    
    .btn-details {
        background: #3498db;
    }
    
    .btn-details:hover {
        background: #2980b9;
    }

    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    .btn-danger {
        background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }

    .btn-export {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
    }

    .table-container {
        overflow-x: auto;
        padding: 25px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }

    th {
        background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
        color: white;
        padding: 18px 15px;
        text-align: left;
        font-weight: 600;
        font-size: 0.95em;
        white-space: nowrap;
    }

    td {
        padding: 15px;
        border-bottom: 1px solid #f1f3f4;
        vertical-align: top;
    }

    tr:hover {
        background: #f8f9fa;
    }

    .criticite-faible { background-color: #d4edda; color: #155724; }
    .criticite-moyenne { background-color: #fff3cd; color: #856404; }
    .criticite-elev√©e { background-color: #f8d7da; color: #721c24; }
    .criticite-critique { background-color: #f5c6cb; color: #721c24; font-weight: bold; }

    .monopole-oui { background-color: #f8d7da; color: #721c24; font-weight: 600; }
    .monopole-non { background-color: #d4edda; color: #155724; }

    .maintenabilite-facile { background-color: #d4edda; color: #155724; }
    .maintenabilite-moyenne { background-color: #fff3cd; color: #856404; }
    .maintenabilite-difficile { background-color: #f8d7da; color: #721c24; }

    .delete-btn {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
    }

    .delete-btn:hover {
        background: #c0392b;
        transform: scale(1.05);
    }

    .details-btn {
        background: #3498db;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.3s ease;
    }

    .details-btn:hover {
        background: #2980b9;
        transform: scale(1.05);
    }

    .stats {
        background: #f8f9fa;
        padding: 25px;
        border-top: 1px solid #dee2e6;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }

    .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 5px;
    }

    .stat-label {
        color: #6c757d;
        font-size: 0.9em;
    }

    .filter-container {
        background: white;
        padding: 15px;
        border-radius: 8px;
        margin-left: auto;
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .details-section {
        display: none; /* Hidden by default */
        padding: 25px;
    }

    .details-section h2 {
        margin-bottom: 15px;
        color: #2c3e50;
    }

    .details-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    @media (max-width: 768px) {
        .controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .control-group {
            width: 100%;
        }
        
        .filter-container {
            margin-left: 0;
            margin-top: 15px;
        }
    }
</style>
</head>
<body>
  <h1>üìä Recensement des Syst√®mes</h1>

  <div class="controls">
    <div>
      <label>Site</label><br>
      <select id="site">
        <option value="">S√©lectionner un site</option>
        <option value="VOLTAIRE_BIDART">VOLTAIRE_BIDART</option>
        <option value="VOLTAIRE_MOLENE">VOLTAIRE_MOLENE</option>
        <option value="MEYER_COGNAC">MEYER_COGNAC</option>
      </select>
    </div>
    <div>
      <label>Nom du Syst√®me</label><br>
      <input type="text" id="nomSysteme">
    </div>
    <div>
      <label>Heures/Jour</label><br>
      <input type="number" id="heuresJour" min="0" max="24">
    </div>
    <div>
      <label>Jours/Semaine</label><br>
      <input type="number" id="joursSemaine" min="1" max="7">
    </div>
    <div>
      <label>Criticit√©</label><br>
      <select id="criticiteSysteme">
        <option value="">S√©lectionner</option>
        <option value="Faible">Faible</option>
        <option value="Moyenne">Moyenne</option>
        <option value="√âlev√©e">√âlev√©e</option>
        <option value="Critique">Critique</option>
      </select>
    </div>
    <div>
      <label>En service</label><br>
      <select id="service">
        <option value="">S√©lectionner</option>
        <option value="Oui">Oui</option>
        <option value="Non">Non</option>
      </select>
    </div>
    <div>
      <label>Maintenabilit√©</label><br>
      <select id="maintenabilite">
        <option value="">S√©lectionner</option>
        <option value="Facile">Facile</option>
        <option value="Moyenne">Moyenne</option>
        <option value="Difficile">Difficile</option>
      </select>
    </div>
    <div style="align-self:flex-end;">
      <button id="btnAjouter" class="btn btn-primary">‚ûï Ajouter Syst√®me</button>
    </div>
  </div>

  <table id="tableauSystemes">
    <thead>
      <tr>
        <th>Site</th>
        <th>Nom Syst√®me</th>
        <th>H/J</th>
        <th>J/S</th>
        <th>Total H/S</th>
        <th>Criticit√©</th>
        <th>En service </th>
        <th>Maintenabilit√©</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="corpsTableau"></tbody>
  </table>

  <!-- Section d√©tails -->
  <div class="details-section" id="detailsSection">
    <div class="details-header">
      <h2>D√©tails du syst√®me : <span id="detailsSystemeNom"></span></h2>
      <div>
        <button onclick="modifierDetails()" class="btn btn-info">‚úèÔ∏è Modifier</button>
        <button onclick="masquerDetails()" class="btn btn-danger">‚ùå Fermer</button>
      </div>
    </div>
    <table class="details-table">
      <tr><th>Nb employ√©s affect√©s</th><td id="nbEmployesValue"></td></tr>
      <tr><th>Taux horaire</th><td id="tauxHoraireValue"></td></tr>
      <tr><th>Machines similaires</th><td id="nbMachinesSimilairesValue"></td></tr>
      <tr><th>Temps total de panne (h)</th><td id="tempsPanneValue"></td></tr>
      <tr><th>Nombre de pannes</th><td id="nbPannesValue"></td></tr>
      <tr><th>Co√ªt d'indisponibilit√© /h</th><td id="coutHeureValue"></td></tr>
      <tr><th>MTBF (h)</th><td id="mtbfValue"></td></tr>
    </table>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://wmdghiouwtezkndrhsgm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndtZGdoaW91d3RlemtuZHJoc2dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MTAxNTgsImV4cCI6MjA3MTE4NjE1OH0.kjGVpTkzQsofxYte1JrYlq3A0BnJ3igI2WQPMttaB84";
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let systemes = [];
    let systemeActuel = null;

    // Charger les syst√®mes
    async function chargerDonnees() {
      const { data, error } = await supabaseClient.from("systemes").select("*").order("id", { ascending:false });
      if (error) { console.error(error); return; }
      systemes = data;
      afficherTableau();
    }

    // Ajouter un syst√®me
    async function ajouterSysteme() {
      const site = document.getElementById("site").value;
      const nomSysteme = document.getElementById("nomSysteme").value;
      const heuresJour = parseFloat(document.getElementById("heuresJour").value) || 0;
      const joursSemaine = parseInt(document.getElementById("joursSemaine").value) || 0;
      const criticite = document.getElementById("criticiteSysteme").value;
      const service = document.getElementById("service").value;
      const maintenabilite = document.getElementById("maintenabilite").value;

      if (!site || !nomSysteme) { alert("Champs obligatoires manquants"); return; }

      const nouveauSysteme = {
        site, nom_systeme: nomSysteme, heures_jour: heuresJour, jours_semaine: joursSemaine,
        total_heures: heuresJour * joursSemaine,
        criticite, service, maintenabilite,
        nb_employes:0, taux_horaire:0, nb_machines_similaires:1, temps_panne:0, nb_pannes:0
      };

      const { error } = await supabaseClient.from("systemes").insert([nouveauSysteme]);
      if (error) console.error(error);
      else chargerDonnees();
    }

    function afficherTableau() {
      const corps = document.getElementById("corpsTableau");
      corps.innerHTML = "";
      systemes.forEach(s => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${s.site}</td>
          <td>${s.nom_systeme}</td>
          <td>${s.heures_jour}</td>
          <td>${s.jours_semaine}</td>
          <td>${s.total_heures}</td>
          <td>${s.criticite}</td>
          <td>${s.service}</td>
          <td>${s.maintenabilite}</td>
          <td>
            <button class="btn btn-info" onclick="afficherDetails(${s.id})">D√©tails</button>
            <button class="btn btn-danger" onclick="supprimerSysteme(${s.id})">Supprimer</button>
          </td>
        `;
        corps.appendChild(tr);
      });
    }

    async function afficherDetails(id) {
      const systeme = systemes.find(s => s.id === id);
      if (!systeme) return;
      systemeActuel = systeme;

      const coutIndispo = (systeme.nb_employes * systeme.taux_horaire) / (systeme.nb_machines_similaires || 1);
      const totalFonctionnement = systeme.total_heures * 52;
      const mtbf = systeme.nb_pannes > 0 ? (totalFonctionnement / systeme.nb_pannes).toFixed(2) : "N/A";

      document.getElementById("detailsSystemeNom").textContent = systeme.nom_systeme;
      document.getElementById("nbEmployesValue").textContent = systeme.nb_employes;
      document.getElementById("tauxHoraireValue").textContent = systeme.taux_horaire + " ‚Ç¨";
      document.getElementById("nbMachinesSimilairesValue").textContent = systeme.nb_machines_similaires;
      document.getElementById("tempsPanneValue").textContent = systeme.temps_panne + " h";
      document.getElementById("nbPannesValue").textContent = systeme.nb_pannes;
      document.getElementById("coutHeureValue").textContent = isNaN(coutIndispo) ? "N/A" : coutIndispo.toFixed(2) + " ‚Ç¨/h";
      document.getElementById("mtbfValue").textContent = mtbf;

      document.getElementById("detailsSection").style.display = "block";
    }

    async function modifierDetails() {
      if (!systemeActuel) return;

      const nbEmployes = parseInt(prompt("Nb employ√©s:", systemeActuel.nb_employes)) || 0;
      const tauxHoraire = parseFloat(prompt("Taux horaire (‚Ç¨):", systemeActuel.taux_horaire)) || 0;
      const nbMachines = parseInt(prompt("Nb machines similaires:", systemeActuel.nb_machines_similaires)) || 1;
      const tempsPanne = parseFloat(prompt("Temps panne (h):", systemeActuel.temps_panne)) || 0;
      const nbPannes = parseInt(prompt("Nb pannes:", systemeActuel.nb_pannes)) || 0;

      const maj = { nb_employes: nbEmployes, taux_horaire:tauxHoraire, nb_machines_similaires:nbMachines, temps_panne:tempsPanne, nb_pannes:nbPannes };

      const { error } = await supabaseClient.from("systemes").update(maj).eq("id", systemeActuel.id);
      if (error) { console.error(error); return; }

      Object.assign(systemeActuel, maj);
      afficherDetails(systemeActuel.id);
      chargerDonnees();
    }

    async function supprimerSysteme(id) {
      if (!confirm("Supprimer ce syst√®me ?")) return;
      await supabaseClient.from("systemes").delete().eq("id", id);
      masquerDetails();
      chargerDonnees();
    }

    function masquerDetails() {
      document.getElementById("detailsSection").style.display = "none";
    }

    // Init
    document.getElementById("btnAjouter").addEventListener("click", ajouterSysteme);
    chargerDonnees();
  </script>
</body>
</html>

