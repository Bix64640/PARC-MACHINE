<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recensement des Syst√®mes</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
      overflow: hidden;
    }
    h1 { text-align: center; color:white; margin-bottom:20px; }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      padding: 20px;
      background: white;
      border-bottom: 1px solid #ddd;
      border-radius: 12px;
      margin: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .control-group { flex:1 1 200px; }
    label { font-weight: bold; color: #2c3e50; }

    input, select {
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
      width: 100%;
    }
    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn:hover { background: #5563d6; }

    .filter-bar {
      display: flex;
      gap: 20px;
      font-size: 1.8em;
      margin: 10px 20px;
      cursor: pointer;
    }
    .filter-icon:hover { transform: scale(1.2); }
    .filtre-wrapper { display: none; margin: 10px 20px; }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      margin: 20px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      font-size: 0.9em;
    }
    th, td {
      padding: 8px;
      border: 1px solid #ddd;
      text-align: center;
    }
    th {
      background: #34495e;
      color: white;
    }
    .details-section {
      display: none;
      padding: 20px;
      border-top: 2px solid #ddd;
      background: #f9f9f9;
    }
    .details-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .close-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    .close-btn:hover { background: #c0392b; }
  </style>
</head>
<body>
  <h1>üìä Recensement des Syst√®mes</h1>

  <!-- Formulaire ajout -->
  <div class="controls">
    <div><label>Site</label><br>
      <select id="site">
        <option value="">S√©lectionner un site</option>
        <option value="VOLTAIRE_BIDART">VOLTAIRE_BIDART</option>
        <option value="VOLTAIRE_MOLENE">VOLTAIRE_MOLENE</option>
        <option value="MEYER_COGNAC">MEYER_COGNAC</option>
      </select>
    </div>
    <div><label>Nom du Syst√®me</label><br>
      <input type="text" id="nomSysteme">
    </div>
    <div><label>Fonction du Syst√®me</label><br>
      <select id="fonction">
        <option value="">S√©lectionner</option>
        <option value="DECOUPER">D√©couper</option>
        <option value="REFENDRE">Refendre</option>
        <option value="PARER">Parage</option>
        <option value="JOINTURE">Jointure</option>
        <option value="PIQUER">Piquer</option>
        <option value="COLLER">Coller</option>
        <option value="MARQUER">Marquer cuir</option>
        <option value="ASSEMBLER">Assembler</option>
        <option value="PONCER">Pon√ßer</option>
        <option value="POLIR">Polir</option>
      </select>
    </div>
    <div><label>Heures/Jour</label><br>
      <input type="number" id="heuresJour" min="0" max="24">
    </div>
    <div><label>Jours/Semaine</label><br>
      <input type="number" id="joursSemaine" min="1" max="7">
    </div>
    <div><label>Criticit√©</label><br>
      <select id="criticiteSysteme">
        <option value="">S√©lectionner</option>
        <option value="Faible">Faible</option>
        <option value="Moyenne">Moyenne</option>
        <option value="√âlev√©e">√âlev√©e</option>
        <option value="Critique">Critique</option>
      </select>
    </div>
    <div><label>En service</label><br>
      <select id="service">
        <option value="">S√©lectionner</option>
        <option value="Oui">Oui</option>
        <option value="Non">Non</option>
      </select>
    </div>
    <div><label>Maintenabilit√©</label><br>
      <select id="maintenabilite">
        <option value="">S√©lectionner</option>
        <option value="Facile">Facile</option>
        <option value="Moyenne">Moyenne</option>
        <option value="Difficile">Difficile</option>
      </select>
    </div>
    <div style="align-self:flex-end;">
      <button id="btnAjouter" class="btn">‚ûï Ajouter Syst√®me</button>
    </div>
  </div>

  <!-- Ic√¥nes filtres -->
  <div class="filter-bar">
    <span class="filter-icon" onclick="toggleFiltre('site')">üìç</span>
    <span class="filter-icon" onclick="toggleFiltre('service')">‚ö°</span>
    <span class="filter-icon" onclick="toggleFiltre('fonction')">‚öôÔ∏è</span>
  </div>

  <!-- Menus filtres -->
  <div id="filtreSiteWrapper" class="filtre-wrapper">
    <label>Filtrer par Site</label><br>
    <select id="filtreSite" onchange="afficherTableau()">
      <option value="">Tous</option>
      <option value="VOLTAIRE_BIDART">VOLTAIRE_BIDART</option>
      <option value="VOLTAIRE_MOLENE">VOLTAIRE_MOLENE</option>
      <option value="MEYER_COGNAC">MEYER_COGNAC</option>
    </select>
  </div>
  <div id="filtreServiceWrapper" class="filtre-wrapper">
    <label>Filtrer par En service</label><br>
    <select id="filtreService" onchange="afficherTableau()">
      <option value="">Tous</option>
      <option value="Oui">Oui</option>
      <option value="Non">Non</option>
    </select>
  </div>
  <div id="filtreFonctionWrapper" class="filtre-wrapper">
    <label>Filtrer par Fonction</label><br>
    <select id="filtreFonction" onchange="afficherTableau()">
      <option value="">Toutes</option>
      <option value="DECOUPER">D√©couper</option>
      <option value="REFENDRE">Refendre</option>
      <option value="PARER">Parage</option>
      <option value="JOINTURE">Jointure</option>
      <option value="PIQUER">Piquer</option>
      <option value="COLLER">Coller</option>
      <option value="MARQUER">Marquer cuir</option>
      <option value="ASSEMBLER">Assembler</option>
      <option value="PONCER">Pon√ßer</option>
      <option value="POLIR">Polir</option>
    </select>
  </div>

  <!-- Tableau -->
  <table id="tableauSystemes">
    <thead>
      <tr>
        <th>Site</th>
        <th>Nom Syst√®me</th>
        <th>Fonction Syst√®me</th>
        <th>H/J</th>
        <th>J/S</th>
        <th>Total H/S</th>
        <th>Criticit√©</th>
        <th>En service</th>
        <th>Maintenabilit√©</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="corpsTableau"></tbody>
  </table>

  <!-- Section d√©tails -->
  <div class="details-section" id="detailsSection">
    <div class="details-header">
      <h2>D√©tails du syst√®me : <span id="detailsSystemeNom"></span></h2>
      <div>
        <button onclick="modifierDetails()" class="btn">‚úèÔ∏è Modifier</button>
        <button onclick="masquerDetails()" class="close-btn">‚ùå Fermer</button>
      </div>
    </div>
    <table class="details-table">
      <tr><th>Nb employ√©s affect√©s</th><td id="nbEmployesValue"></td></tr>
      <tr><th>Taux horaire</th><td id="tauxHoraireValue"></td></tr>
      <tr><th>Machines similaires</th><td id="nbMachinesSimilairesValue"></td></tr>
      <tr><th>Temps total de panne (h)</th><td id="tempsPanneValue"></td></tr>
      <tr><th>Nombre de pannes</th><td id="nbPannesValue"></td></tr>
      <tr><th>Co√ªt d'indisponibilit√© /h</th><td id="coutHeureValue"></td></tr>
      <tr><th>MTBF (h)</th><td id="mtbfValue"></td></tr>
    </table>
  </div>

  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://wmdghiouwtezkndrhsgm.supabase.co";
    const SUPABASE_ANON_KEY = "TA_CLE_ANON";
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let systemes = [];
    let systemeActuel = null;

    function toggleFiltre(type) {
      document.getElementById("filtreSiteWrapper").style.display = (type === 'site') ? "block" : "none";
      document.getElementById("filtreServiceWrapper").style.display = (type === 'service') ? "block" : "none";
      document.getElementById("filtreFonctionWrapper").style.display = (type === 'fonction') ? "block" : "none";
    }

    async function chargerDonnees() {
      const { data, error } = await supabaseClient.from("systemes").select("*").order("id", { ascending:false });
      if (error) { console.error(error); return; }
      systemes = data;
      afficherTableau();
    }

    async function ajouterSysteme() {
      const site = document.getElementById("site").value;
      const nomSysteme = document.getElementById("nomSysteme").value;
      const fonction = document.getElementById("fonction").value;
      const heuresJour = parseFloat(document.getElementById("heuresJour").value) || 0;
      const joursSemaine = parseInt(document.getElementById("joursSemaine").value) || 0;
      const criticite = document.getElementById("criticiteSysteme").value;
      const service = document.getElementById("service").value;
      const maintenabilite = document.getElementById("maintenabilite").value;

      if (!site || !nomSysteme) { alert("Champs obligatoires manquants"); return; }

      const nouveauSysteme = {
        site, nom_systeme: nomSysteme, fonction_production: fonction,
        heures_jour: heuresJour, jours_semaine: joursSemaine,
        total_heures: heuresJour * joursSemaine,
        criticite, service, maintenabilite,
        nb_employes:0, taux_horaire:0, nb_machines_similaires:1, temps_panne:0, nb_pannes:0
      };

      const { error } = await supabaseClient.from("systemes").insert([nouveauSysteme]);
      if (error) console.error(error);
      else chargerDonnees();
    }

    function afficherTableau() {
      const filtreSite = document.getElementById("filtreSite").value;
      const filtreService = document.getElementById("filtreService").value;
      const filtreFonction = document.getElementById("filtreFonction").value;

      const corps = document.getElementById("corpsTableau");
      corps.innerHTML = "";

      systemes
        .filter(s => !filtreSite || s.site === filtreSite)
        .filter(s => !filtreService || s.service === filtreService)
        .filter(s => !filtreFonction || s.fonction_production === filtreFonction)
        .forEach(s => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${s.site}</td>
            <td>${s.nom_systeme}</td>
            <td>${s.fonction_production || ""}</td>
            <td>${s.heures_jour}</td>
            <td>${s.jours_semaine}</td>
            <td>${s.total_heures}</td>
            <td>${s.criticite}</td>
            <td>${s.service}</td>
            <td>${s.maintenabilite}</td>
            <td>
              <button class="btn" onclick="afficherDetails(${s.id})">D√©tails</button>
              <button class="close-btn" onclick="supprimerSysteme(${s.id})">Supprimer</button>
            </td>
          `;
          corps.appendChild(tr);
        });
    }

    async function afficherDetails(id) {
      const systeme = systemes.find(s => s.id === id);
      if (!systeme) return;
      systemeActuel = systeme;

      const coutIndispo = (systeme.nb_employes * systeme.taux_horaire) / (systeme.nb_machines_similaires || 1);
      const totalFonctionnement = systeme.total_heures * 52;
      const mtbf = systeme.nb_pannes > 0 ? (totalFonctionnement / systeme.nb_pannes).toFixed(2) : "N/A";

      document.getElementById("detailsSystemeNom").textContent = systeme.nom_systeme;
      document.getElementById("nbEmployesValue").textContent = systeme.nb_employes;
      document.getElementById("tauxHoraireValue").textContent = systeme.taux_horaire + " ‚Ç¨";
      document.getElementById("nbMachinesSimilairesValue").textContent = systeme.nb_machines_similaires;
      document.getElementById("tempsPanneValue").textContent = systeme.temps_panne + " h";
      document.getElementById("nbPannesValue").textContent = systeme.nb_pannes;
      document.getElementById("coutHeureValue").textContent = isNaN(coutIndispo) ? "N/A" : coutIndispo.toFixed(2) + " ‚Ç¨/h";
      document.getElementById("mtbfValue").textContent = mtbf;

      document.getElementById("detailsSection").style.display = "block";
    }

    async function modifierDetails() {
      if (!systemeActuel) return;
      const nbEmployes = parseInt(prompt("Nb employ√©s:", systemeActuel.nb_employes)) || 0;
      const tauxHoraire = parseFloat(prompt("Taux horaire (‚Ç¨):", systemeActuel.taux_horaire)) || 0;
      const nbMachines = parseInt(prompt("Nb machines similaires:", systemeActuel.nb_machines_similaires)) || 1;
      const tempsPanne = parseFloat(prompt("Temps panne (h):", systemeActuel.temps_panne)) || 0;
      const nbPannes = parseInt(prompt("Nb pannes:", systemeActuel.nb_pannes)) || 0;

      const maj = { nb_employes: nbEmployes, taux_horaire:tauxHoraire, nb_machines_similaires:nbMachines, temps_panne:tempsPanne, nb_pannes:nbPannes };
      const { error } = await supabaseClient.from("systemes").update(maj).eq("id", systemeActuel.id);
      if (error) { console.error(error); return; }
      Object.assign(systemeActuel, maj);
      afficherDetails(systemeActuel.id);
      chargerDonnees();
    }

    async function supprimerSysteme(id) {
      if (!confirm("Supprimer ce syst√®me ?")) return;
      await supabaseClient.from("systemes").delete().eq("id", id);
      masquerDetails();
      chargerDonnees();
    }

    function masquerDetails() {
      document.getElementById("detailsSection").style.display = "none";
    }

    document.getElementById("btnAjouter").addEventListener("click", ajouterSysteme);
    chargerDonnees();
  </script>
</body>
</html>
